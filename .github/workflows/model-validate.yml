name: Model Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'models/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'models/**'

jobs:
  validate-models:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Find changed models
        id: changed-models
        run: |
          # Find model directories (excluding metadata and registry)
          MODELS=$(find models -type d -mindepth 1 -maxdepth 1 2>/dev/null | grep -v metadata | grep -v registry || echo "")
          # Store as JSON array for proper handling
          if [ -n "$MODELS" ]; then
            echo "has_models=true" >> $GITHUB_OUTPUT
            echo "models<<EOF" >> $GITHUB_OUTPUT
            echo "$MODELS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_models=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate model metadata
        if: steps.changed-models.outputs.has_models == 'true'
        run: |
          EXIT_CODE=0
          # Read models line by line to handle multi-line output
          while IFS= read -r model_dir; do
            if [ -n "$model_dir" ] && [ -d "$model_dir" ]; then
              echo "Validating $model_dir..."
              if ! ./scripts/validate-model.sh "$model_dir"; then
                echo "Validation failed for $model_dir"
                EXIT_CODE=1
              fi
            fi
          done <<< "${{ steps.changed-models.outputs.models }}"
          exit $EXIT_CODE
      
      - name: Validate model metadata schema
        run: |
          if [ -f "models/metadata/schema.json" ]; then
            echo "Validating model metadata schema..."
            node -e "JSON.parse(require('fs').readFileSync('models/metadata/schema.json', 'utf8'))" && echo "âœ“ Schema is valid JSON"
          fi
      
      - name: Check model versioning
        run: |
          echo "Checking model versions..."
          find models -name "metadata.json" -type f | while read metadata; do
            VERSION=$(node -e "console.log(JSON.parse(require('fs').readFileSync('$metadata', 'utf8')).version || 'missing')")
            echo "  $(dirname $metadata): $VERSION"
          done
